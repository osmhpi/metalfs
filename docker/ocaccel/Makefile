export VIVADO_EDITION ?= hl_design_edition
METAL_TAG ?= $(shell if [ -z "`git status --porcelain`" ]; then git rev-parse --short HEAD; else echo dirty; fi)
export METAL_TAG := ${METAL_TAG}

IMAGE_NAMESPACE = reg.osmhpi.de/metalfs

docker_build := docker build --build-arg VIVADO_EDITION --build-arg PSL --build-arg METAL_TAG

.PHONY: runtime sdk-base sdk

all-sdk: sdk-base sdk
all-runtime: runtime

git-is-clean:
ifeq '${shell git status --porcelain}' ''
	@ # git is clean
else
	${error Git status is not clean.}
endif


latest-sdk-base: git-is-clean sdk-base
	docker tag $(IMAGE_NAMESPACE)/sdk-ocaccel-base:${METAL_TAG}-${VIVADO_EDITION}       $(IMAGE_NAMESPACE)/sdk-ocaccel-base:latest
latest-sdk: git-is-clean sdk
	docker tag $(IMAGE_NAMESPACE)/sdk-ocaccel:${METAL_TAG}-${VIVADO_EDITION} 			$(IMAGE_NAMESPACE)/sdk-ocaccel:latest
lastest-runtime: git-is-clean all-runtime
	docker tag $(IMAGE_NAMESPACE)/runtime:${METAL_TAG}                                  $(IMAGE_NAMESPACE)/runtime:latest

sdk-base:
	${docker_build} \
		-t $(IMAGE_NAMESPACE)/sdk-ocaccel-base:${METAL_TAG}-${VIVADO_EDITION} \
		-f sdk-base/Dockerfile \
		../..

sdk:
	${docker_build} \
		-t $(IMAGE_NAMESPACE)/sdk-ocaccel:${METAL_TAG}-${VIVADO_EDITION} \
		-f sdk/Dockerfile \
		../..

runtime:
	${docker_build} \
		-t $(IMAGE_NAMESPACE)/runtime:${METAL_TAG} \
		-f runtime/Dockerfile.ppc64le \
		../..

pull-latest-sdk:
	docker pull $(IMAGE_NAMESPACE)/sdk-ocaccel-base:latest || true
	docker pull $(IMAGE_NAMESPACE)/sdk-ocaccel:latest || true
pull-latest-runtime:
	docker pull $(IMAGE_NAMESPACE)/runtime:latest || true

push-sdk:
	SUBTAG=$$(echo '${METAL_TAG}' | tr -d 'v') ; \
	if [ $$(echo $$SUBTAG | grep -iE '^[0-9]+\.[0-9]+\.[0-9]+$$' | wc -l) -ne 0 ] ; then \
		while [ ! -z "$$SUBTAG" ]; do \
			docker tag $(IMAGE_NAMESPACE)/sdk-ocaccel-base:${METAL_TAG}-${VIVADO_EDITION}   $(IMAGE_NAMESPACE)/sdk-ocaccel-base:$$SUBTAG-${VIVADO_EDITION} ; \
			docker tag $(IMAGE_NAMESPACE)/sdk-ocaccel:${METAL_TAG}-${VIVADO_EDITION} 		$(IMAGE_NAMESPACE)/sdk-ocaccel:$$SUBTAG-${VIVADO_EDITION} ; \
			docker push $(IMAGE_NAMESPACE)/sdk-ocaccel-base:$$SUBTAG-${VIVADO_EDITION} ; \
			docker push $(IMAGE_NAMESPACE)/sdk-ocaccel:$$SUBTAG-${VIVADO_EDITION} ; \
			SUBTAG=$$(echo "$$SUBTAG" | awk '{gsub(/\.?[0-9]+$$/,"",$$1);print}') ; \
		done ; \
	fi

push-runtime:
	docker push $(IMAGE_NAMESPACE)/runtime:${METAL_TAG}

push-latest-sdk: git-is-clean
	docker push $(IMAGE_NAMESPACE)/sdk-ocaccel-base:latest
	docker push $(IMAGE_NAMESPACE)/sdk-ocaccel:latest
push-latest-runtime: git-is-clean
	docker push $(IMAGE_NAMESPACE)/runtime:latest
